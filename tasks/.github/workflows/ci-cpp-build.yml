name: C++ Build, Test, and Generate Report

on:
  push:
    branches: [main, hw]
  pull_request:
    branches: [main, hw]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            g++ \
            clang \
            ninja-build \
            xsltproc

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          cd build
          cmake --build . --config Release

      - name: Run tests and generate reports
        id: run_tests
        continue-on-error: true
        run: |
          set +e  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
          
          mkdir -p test-results
          has_failures=0
          tests_run=0
          tests_passed=0
          
          echo "==========================================="
          echo "Searching for test executables..."
          echo "==========================================="
          
          cd build
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ tasks
          echo "Directory structure:"
          ls -la tasks/ 2>/dev/null || echo "tasks directory not found"
          echo ""
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã
          echo "Found executables:"
          find tasks -type f -executable 2>/dev/null | sort | tee /tmp/found_tests.txt
          test_count=$(wc -l < /tmp/found_tests.txt)
          echo ""
          echo "Total executables found: $test_count"
          echo "==========================================="
          echo ""
          
          # –°–æ–∑–¥–∞–µ–º –ª–æ–≥ —Ñ–∞–π–ª –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
          echo "Test Name,Status,Exit Code,XML Generated" > /tmp/test_results.csv
          
          # –ò—â–µ–º –≤—Å–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ tasks
          while IFS= read -r test_bin; do
            if [ -f "$test_bin" ] && [ -x "$test_bin" ]; then
              test_name=$(basename "$test_bin")
              tests_run=$((tests_run + 1))
              xml_path="../test-results/${test_name}.xml"
              
              echo ""
              echo "==========================================="
              echo "[$tests_run] Running: $test_name"
              echo "==========================================="
              
              # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π XML
              timeout 60s ./"$test_bin" --gtest_output=xml:$xml_path 2>&1
              test_status=$?
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–ª—Å—è –ª–∏ XML —Ñ–∞–π–ª
              xml_generated="NO"
              if [ -f "$xml_path" ]; then
                xml_generated="YES"
              fi
              
              if [ $test_status -eq 0 ]; then
                echo "‚úÖ PASSED: $test_name"
                echo "$test_name,PASSED,0,$xml_generated" >> /tmp/test_results.csv
                tests_passed=$((tests_passed + 1))
              elif [ $test_status -eq 124 ]; then
                echo "‚è±Ô∏è TIMEOUT: $test_name (exceeded 60 seconds)"
                echo "$test_name,TIMEOUT,124,$xml_generated" >> /tmp/test_results.csv
                has_failures=1
              elif [ $test_status -eq 139 ]; then
                echo "üí• SEGFAULT: $test_name (segmentation fault)"
                echo "$test_name,SEGFAULT,139,$xml_generated" >> /tmp/test_results.csv
                has_failures=1
              elif [ $test_status -eq 134 ]; then
                echo "üí• ABORTED: $test_name (abort signal)"
                echo "$test_name,ABORTED,134,$xml_generated" >> /tmp/test_results.csv
                has_failures=1
              else
                echo "‚ùå FAILED: $test_name (exit code: $test_status)"
                echo "$test_name,FAILED,$test_status,$xml_generated" >> /tmp/test_results.csv
                has_failures=1
              fi
            fi
          done < <(find tasks -type f -executable 2>/dev/null)
          
          cd ..
          
          echo ""
          echo "==========================================="
          echo "Test Execution Summary"
          echo "==========================================="
          echo "Total tests run: $tests_run"
          echo "Tests passed: $tests_passed"
          echo "Tests failed: $((tests_run - tests_passed))"
          echo ""
          
          echo "Detailed Results:"
          column -t -s',' /tmp/test_results.csv
          
          echo ""
          echo "Generated XML reports:"
          xml_count=$(ls test-results/*.xml 2>/dev/null | wc -l)
          if [ $xml_count -gt 0 ]; then
            ls -lh test-results/*.xml | awk '{print "  ‚úÖ " $9 " (" $5 ")"}'
            echo ""
            echo "‚ö†Ô∏è  Tests without XML reports (crashed before completion):"
            while IFS=, read -r name status code xml; do
              if [ "$xml" = "NO" ] && [ "$name" != "Test Name" ]; then
                echo "  ‚ùå $name ($status)"
              fi
            done < /tmp/test_results.csv
          else
            echo "  ‚ö†Ô∏è  No XML files generated"
          fi
          echo "==========================================="
          
          exit $has_failures

      - name: Upload test results (XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test_results_xml
          path: test-results/*.xml
          if-no-files-found: warn
          retention-days: 7

      - name: Generate HTML reports
        if: always()
        run: |
          echo "==========================================="
          echo "Generating HTML Reports"
          echo "==========================================="
          
          if [ ! -f "transform.xsl" ]; then
            echo "‚ö†Ô∏è Warning: transform.xsl not found, skipping HTML generation"
            exit 0
          fi
          
          xml_count=0
          html_count=0
          
          if [ -d "test-results" ]; then
            for xml_file in test-results/*.xml; do
              if [ -f "$xml_file" ]; then
                xml_count=$((xml_count + 1))
                html_file="${xml_file%.xml}.html"
                
                if xsltproc transform.xsl "$xml_file" > "$html_file" 2>&1; then
                  html_count=$((html_count + 1))
                  echo "‚úÖ Generated: $(basename "$html_file")"
                else
                  echo "‚ùå Failed to generate: $(basename "$html_file")"
                fi
              fi
            done
          fi
          
          echo ""
          echo "Summary: Generated $html_count HTML reports from $xml_count XML files"
          echo "==========================================="

      - name: Upload HTML reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test_reports_html
          path: test-results/*.html
          if-no-files-found: warn
          retention-days: 7

      - name: Publish test summary
        if: always()
        run: |
          echo "## üß™ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          xml_count=$(ls test-results/*.xml 2>/dev/null | wc -l)
          html_count=$(ls test-results/*.html 2>/dev/null | wc -l)
          
          echo "üìä **Reports Generated:**" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ XML Reports: $xml_count" >> $GITHUB_STEP_SUMMARY
          echo "- üåê HTML Reports: $html_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "/tmp/test_results.csv" ]; then
            echo "### üìã Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test Name | Status | Exit Code | XML Report |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|--------|-----------|------------|" >> $GITHUB_STEP_SUMMARY
            
            while IFS=, read -r name status code xml; do
              if [ "$name" != "Test Name" ]; then
                if [ "$status" = "PASSED" ]; then
                  icon="‚úÖ"
                elif [ "$status" = "SEGFAULT" ] || [ "$status" = "ABORTED" ]; then
                  icon="üí•"
                elif [ "$status" = "TIMEOUT" ]; then
                  icon="‚è±Ô∏è"
                else
                  icon="‚ùå"
                fi
                
                xml_icon="‚ùå"
                [ "$xml" = "YES" ] && xml_icon="‚úÖ"
                
                echo "| \`$name\` | $icon $status | $code | $xml_icon |" >> $GITHUB_STEP_SUMMARY
              fi
            done < /tmp/test_results.csv
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ $xml_count -gt 0 ]; then
            echo "üì• **Download artifacts to view detailed HTML reports**" >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results available" >> $GITHUB_STEP_SUMMARY
          fi
